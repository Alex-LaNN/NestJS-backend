# Указание базового образа Node.js для этапа сборки
FROM node:20-alpine AS builder

# Установка рабочей директории
WORKDIR /usr/src

# Аргументы, которые будут переданы из docker-compose.test.yml
ARG NODE_ENV
ARG ENV_FILE

# Копирование всех файлов проекта
COPY . .

RUN echo "Просмотр из Dockerfile.test после COPY . ."
RUN pwd
RUN ls -lart

# Копирование нужного .env-файла, зависящего от ENV_FILE
COPY ${ENV_FILE} ./.env

# Второй этап: создание финального образа
FROM node:20-alpine

# Установка рабочей директории
WORKDIR /usr/src

# Копирование всех файлов проекта для тестирования
COPY --from=builder /usr/src ./

RUN echo "Просмотр из Dockerfile.test после COPY --from=builder /usr/src ./"
RUN pwd
RUN ls -lart

# Копирование скрипта для тестов и делаем его исполняемым
COPY run-tests.sh /usr/src/run-tests.sh
RUN chmod +x /usr/src/run-tests.sh

# Запуск скрипта тестирования
CMD ["/usr/src/run-tests.sh"]
